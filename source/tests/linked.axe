use stdlib/arena (
    Arena,
    arena_create,
    arena_destroy,
    arena_alloc
);

use stdlib/memory (
    size_of
);

model Node {
    value: int;
    next: long;   // pointer (numeric) to another Node, 0 == null
}

/// Returns a null list head (0).
def make_null_head(): long {
    return 0;
}

/// Push a new value to the front of the list. Returns new head pointer.
def list_push_front(head: long, arena: Arena, value: int): long {
    // allocate a new Node from the arena
    val ptr: long = arena_alloc(ref_of(arena), size_of(Node));
    mut val n: ref Node = deref(ptr);

    n.value = value;
    n.next = head;

    return ptr;
}

/// Push a new value to the back of the list. Returns head pointer (unchanged for non-empty lists).
def list_push_back(head: long, arena: Arena, value: int): long {
    // empty list -> push front
    if head == 0 {
        return list_push_front(head, arena, value);
    }

    // traverse to last node
    mut val cur_ptr: long = head;
    loop {
        mut val cur: ref Node = deref(cur_ptr);
        if cur.next == 0 {
            break;
        }
        cur_ptr = cur.next;
    }

    // allocate new node and append
    val ptr: long = arena_alloc(ref_of(arena), size_of(Node));
    mut val newn: ref Node = deref(ptr);
    newn.value = value;
    newn.next = 0;

    // set last.next = ptr
    mut val last: ref Node = deref(cur_ptr);
    last.next = ptr;

    return head;
}

/// Print values from head to null.
def list_print(head: long) {
    mut val cur_ptr: long = head;

    loop {
        if cur_ptr == 0 {
            break;
        }

        mut val cur: ref Node = deref(cur_ptr);
        print cur.value;
        print " ";

        cur_ptr = cur.next;
    }

    println "";
}

main {
    println "=== LINKED LIST (arena-backed) ===";

    mut val arena: Arena = arena_create(65536);

    // start with empty list
    mut val head: long = make_null_head();

    head = list_push_front(head, arena, 10);
    head = list_push_front(head, arena, 5);
    head = list_push_back(head, arena, 20);
    head = list_push_back(head, arena, 25);

    println "List contents:";
    list_print(head);

    arena_destroy(ref_of(arena));
    println "Arena destroyed.";
}
